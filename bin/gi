#!/bin/bash -e

echoerr() {
	echo "$@" 1>&2;
}
COMMAND=$1

if [ `uname` == 'Darwin' ]; then
	script=$(greadlink -f "$0")
else
	script=$(readlink -f "$0")
fi
DIR_ROOT=$(dirname $script)/../

case "${COMMAND}" in
	'co' ) COMMAND='checkout' ;;
	'li' ) COMMAND='list' ;;
	'det' ) COMMAND='details' ;;
	'pr' ) COMMAND='pull-request' ;;
	'open' )
		echo "Really create a new issue or checkout an existing one [y/E]?"
		read answer
		if ! [[ "${answer}" =~ ^[yY]$ ]]; then
			COMMAND='checkout'
		fi
	;;
	'new' ) COMMAND='open' ;;
esac

if ! (test -e $DIR_ROOT"commands/"$COMMAND); then
	echoerr "Invalid command '$COMMAND'.";
	COMMAND="";
fi

if [ "" == "$COMMAND" ]; then
	echoerr "usage: gi <command>";
	echoerr;
	echoerr "Commands:";
	echoerr "  list | li [<username>|me]      Lists repo's issues (assigned to user if provided)";
	echoerr "  open | new [<message>]          Open a new issue"
	echoerr "  checkout | co <issue-number>   Check out branch for specified issue, create it if needed";
	echoerr "  details | det                   Show current branch-issue's details";
	echoerr "  browse                    Open current branch-issue in web browser";
	echoerr "  comment [<message>]       Add comment to current branch-issue";
	echoerr "  push                      Push current branch-issue to origin";
	echoerr "  pull-request | pr [<target>]   Create a pull-request with the current branch-issue";
	exit 1;
fi

if ! (git remote 2>/dev/null 1>/dev/null); then
	echoerr "Not a git repository";
	exit 1;
fi
if ! (git remote | grep -q '^upstream$'); then
	echoerr "No upstream remote configured. Please add it using git:";
	echoerr "  use (git remote add upstream <url>)";
	exit 1;
fi
shift
echo $DIR_ROOT"commands/${COMMAND} "$@
